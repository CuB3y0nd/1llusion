#!/bin/sh

KEY="8b05d62206f459e1d298cbe5844d7d87"
CITY="Shanghai" # Go to https://openweathermap.org/find to find your city/town
UNITS="metric"  # metric | imperial

wait_for_internet() {
  while ! curl -fsS --max-time 5 https://google.com >/dev/null 2>&1; do
    sleep 0.5
  done
}

get_weather_data() {
  encoded_city=$(printf "%s" "$CITY" | sed 's/ /%20/g')
  url="https://api.openweathermap.org/data/2.5/weather?q=$encoded_city&appid=$KEY&units=$UNITS"

  curl -fsS --max-time 10 "$url"
}

parse_weather_values() {
  data=$1
  W_TEMP=$(echo "$data" | jq -r '.main.temp | round')
  W_FEELS=$(echo "$data" | jq -r '.main.feels_like | round')
  W_DESC=$(echo "$data" | jq -r '.weather[0].description')
  W_ICON=$(echo "$data" | jq -r '.weather[0].icon')
}

get_weather_icon() {
  case "$1" in
  "01d") echo "" ;;
  "01n") echo "" ;;
  "02d") echo "" ;;
  "02n") echo "" ;;
  "03d" | "03n") echo "" ;;
  "04d" | "04n") echo "" ;;
  "09d" | "09n") echo "" ;;
  "10d") echo "" ;;
  "10n") echo "" ;;
  "11d" | "11n") echo "" ;;
  "13d" | "13n") echo "" ;;
  "50d" | "50n") echo "" ;;
  *) echo "" ;;
  esac
}

get_weather_hex() {
  icon_prefix=$(echo "$1" | cut -c1-2)
  case "$icon_prefix" in
  "01") echo "#ffd86b" ;;
  "02" | "03" | "04") echo "#adadff" ;;
  "09" | "10") echo "#6b95ff" ;;
  "11") echo "#ffeb57" ;;
  "13") echo "#e3e6fc" ;;
  "50") echo "#84afdb" ;;
  *) echo "#adadff" ;;
  esac
}

wait_for_internet
weather_data=$(get_weather_data || exit 1)
parse_weather_values "$weather_data"

case "$1" in
"current_temp")
  echo "$W_TEMP"
  ;;
"current_temp_fahrenheit")
  temp_f=$(expr \( "$W_TEMP" \* 9 / 5 \) + 32)
  echo "${temp_f}°F"
  ;;
"feels_like")
  echo "${W_FEELS}°C"
  ;;
"weather_desc")
  echo "$W_DESC" | sed 's/.*/\u&/'
  ;;
"icon")
  get_weather_icon "$W_ICON"
  ;;
"hex")
  get_weather_hex "$W_ICON"
  ;;
"full")
  echo "$weather_data"
  ;;
"city")
  echo "$CITY"
  ;;
"wmodule")
  icon=$(get_weather_icon "$W_ICON")
  hex=$(get_weather_hex "$W_ICON")
  printf "%%{F%s}%s%%{F-} %s°\n" "$hex" "$icon" "$W_TEMP"
  ;;
*)
  echo "No valid option" >&2
  exit 1
  ;;
esac
