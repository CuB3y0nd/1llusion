#!/bin/sh

UPDATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/Updates.txt"

check_updates() {
  # Get official updates
  official=0
  if updates=$(checkupdates 2>/dev/null); then
    official=$(echo "$updates" | wc -l)
  fi

  # Get AUR updates
  aur=0
  if aur_updates=$(paru -Qua 2>/dev/null); then
    aur=$(echo "$aur_updates" | wc -l)
  fi

  # Calculate and write the total to the file
  total=$((official + aur))
  echo "$total" >"$UPDATE_FILE"

  # Sends the signal to polybar-module/eww-poll to update the data.
  if pgrep -x polybar >/dev/null; then
    polybar-msg action updates hook 0 >/dev/null 2>&1
  else
    read -r current_rice <"$HOME"/.config/bspwm/.rice
    eww -c "$HOME/.config/bspwm/rices/${current_rice}/bar" poll UPDATES
  fi
}

list_updates() {
  check_updates
  if [ "$total" -gt 0 ]; then
    printf "\033[1m\033[33mThere are %s updates available:\033[0m\n" "$total"

    if [ -n "$updates" ]; then
      printf "\n\033[1m\033[34mOfficial updates:\033[0m\n"
      printf "%s\n" "$updates" | sed 's/->/\x1b[32;1m\x1b[0m/g'
    fi

    if [ -n "$aur_updates" ]; then
      printf "\n\033[1m\033[34mAUR updates:\033[0m\n"
      printf "%s\n" "$aur_updates" | sed 's/->/\x1b[32;1m\x1b[0m/g'
    fi
  else
    printf "\033[1m\033[32m¡Your system is already updated!\033[0m\n"
  fi
  exit 0
}

# Execute it accordingly
case "$1" in
--sync-polybar)
  check_updates
  ;;
--print-updates)
  list_updates
  ;;
*)
  echo "$(basename "$0") [OPTIONS]"
  echo "  --sync-polybar      Sync data & polybar module"
  echo "  --print-updates     Sync data, polybar module & print available apps to update"
  exit 1
  ;;
esac
